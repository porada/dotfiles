#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

if ! __is_brew_installed; then
  __print_error_and_exit '`brew` needs to be installed before running `dotfiles sync`'
fi

__print_heading 'Syncing dotfiles'

# Sync dotfiles
if __is_callable git; then
  __print_heading_dimmed 'Pulling the repository'

  # Ensure the remote uses SSH
  if __is_ssh_configured; then
    current="$(git -C "$DOTFILES" remote get-url origin)"
    updated="$(__string_replace 'https://github.com/' 'git@github.com:' "$current")"

    if [ "$current" = "$updated" ]; then
      __print_confirmation "$current"
    else
      __ git -C "$DOTFILES" remote set-url origin "$updated"
    fi
  fi

  current_revision="$(__dotfiles_revision)"

  # Ensure there are no staged or unstaged changes
  if __ git -C "$DOTFILES" diff --quiet && __ git -C "$DOTFILES" diff --cached --quiet; then
    __ git -C "$DOTFILES" pull
    __is_callable pnpm && __dotfiles_pnpm_install
  else
    __print_warning 'The repository contains uncommitted changes'
  fi

  if [ "$(__dotfiles_revision)" != "$current_revision" ]; then
    __print_confirmation 'Repository updated'
    __dotfiles_exec sync --print
  fi
fi

__dotfiles sync-migrate
__dotfiles sync-setup
__dotfiles sync-install
__dotfiles sync-macos
__dotfiles sync-update
__dotfiles sync-clean

# Finish with dependency status
__print_heading 'Sync complete'
__dotfiles dependencies || true
__is_fish || echo
