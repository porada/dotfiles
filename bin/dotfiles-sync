#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

if ! __is_brew_installed; then
  __print_error_and_exit '`brew` needs to be installed before running `dotfiles sync`'
fi

if __is_callable git; then
  __print_heading 'Syncing dotfiles'

  # Ensure the remote uses SSH
  if __is_ssh_configured; then
    current="$(git -C "$DOTFILES" remote get-url origin)"
    updated="$(__string_replace 'https://github.com/' 'git@github.com:' "$current")"

    if [ "$current" = "$updated" ]; then
      __print_confirmation "$current"
    else
      __ git -C "$DOTFILES" remote set-url origin "$updated"
    fi
  fi

  current_revision="$(__dotfiles_revision)"

  # Perform the actual update
  if ! __ git -C "$DOTFILES" fetch --quiet; then
    __print_error 'Failed to fetch latest changes'
  elif __ git -C "$DOTFILES" merge-base --is-ancestor '@{u}' HEAD; then
    __print_confirmation 'Up to date'
  else
    __print_heading 'Updating the repository'

    if ! __dotfiles_is_clean; then
      __print_warning 'The repository contains uncommitted changes'
      __ git -C "$DOTFILES" stash
      stashed_changes=true
    fi

    if ! __ git -C "$DOTFILES" rebase; then
      echo
      __print_error 'Failed to update the repository'
      __ git -C "$DOTFILES" rebase --abort || true
    else
      __is_callable pnpm && __dotfiles_pnpm install
      __print_confirmation 'Repository updated'
    fi
  fi

  if [ -n "${stashed_changes-}" ]; then
    if __ git -C "$DOTFILES" stash pop --quiet; then
      __print_confirmation 'Changes restored'
    else
      __print_error 'Failed to restore uncommitted changes'

      __print_heading_dimmed 'Restoring the original state'
      __ git -C "$DOTFILES" reset --hard "$current_revision"
      __is_callable pnpm && __dotfiles_pnpm install

      if __ git -C "$DOTFILES" stash pop --quiet; then
        __print_confirmation 'Original state restored'
      else
        __print_error 'Failed to restore the original state'
      fi
    fi
  fi

  if [ "$(__dotfiles_revision)" != "$current_revision" ]; then
    __print_heading_dimmed 'Restarting the sync after the update'
    __dotfiles_exec sync --print
  fi
fi

__dotfiles sync-migrate
__dotfiles sync-setup
__dotfiles sync-install
__dotfiles sync-macos
__dotfiles sync-update
__dotfiles sync-clean

# Finish with dependency status
__print_heading 'Sync complete'
__dotfiles dependencies || true
__is_fish || echo
