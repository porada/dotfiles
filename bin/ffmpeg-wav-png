#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Batch convert `.wav` and `.png` pairs in the current directory to video files
if ! __is_callable ffmpeg; then
  __print_error_and_exit '`ffmpeg` is missing'
fi

if ! __is_callable ffprobe; then
  __print_error_and_exit '`ffprobe` is missing'
fi

# Parse `--preset` from arguments
preset=""

for param in "$@"; do
  name="${param#--preset=}"

  if [ "$name" != "$param" ]; then
    preset="$name"
  fi
done

if [ -z "$preset" ]; then
  __print_error_and_exit '`--preset` is missing'
fi

if [ "$preset" = "instagram" ]; then
  files="$(find . -maxdepth 1 -name "*.wav" -type f -print)"
  [ -z "$files" ] && __print_info_and_exit 'No `.wav` files found'

  printf "%s\n" "$files" \
    | while IFS= read -r audio; do
      base="${audio%.wav}"
      image="$base.png"
      video="$base.mov"

      if [ ! -f "$image" ]; then
        __print_error "Missing image for \`$audio\`"
        continue
      fi

      __print_heading "Generating \`$video\` for Instagram"

      # Instagram clips can be up to 60 seconds long
      duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$audio")
      duration_param=$(awk -v d="$duration" 'BEGIN { if (d >= 60.0) print "-t 60"; else print "-shortest"; }')

      eval "ffmpeg -nostdin -y -framerate 1 -loop 1 -i \"$image\" -i \"$audio\" -r 1 \
          -vf \"format=rgb24,scale=in_range=full:out_range=tv\" \
          -c:v prores_ks -profile:v 3 -pix_fmt yuv444p10le \
          -color_range 1 -c:a copy $duration_param \"$video\""
    done
fi

if [ "$preset" = "youtube" ]; then
  files="$(find . -maxdepth 1 -name "*.wav" -type f -print)"
  [ -z "$files" ] && __print_info_and_exit 'No `.wav` files found'

  printf "%s\n" "$files" \
    | while IFS= read -r audio; do
      base="${audio%.wav}"
      image="$base.png"
      video="$base.mkv"

      if [ ! -f "$image" ]; then
        __print_error "Missing image for \`$audio\`"
        continue
      fi

      __print_heading "Generating \`$video\` for YouTube"

      ffmpeg -nostdin -loop 1 -framerate 1 -i "$image" -i "$audio" \
        -vf "format=yuv420p,eq=gamma=1.18,scale=out_color_matrix=bt709" \
        -c:v libx264 -crf 0 -preset veryslow -pix_fmt yuv420p \
        -color_range 1 -colorspace 1 -color_primaries 1 -color_trc 1 \
        -c:a copy -shortest -y "$video"
    done
fi
