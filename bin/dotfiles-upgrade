#!/bin/sh

# Enable strict mode
set -eu

get_file_path() {
  realpath "$0"
}

get_file_revision() {
  md5 -q "$(get_file_path)"
}

get_directory_path() {
  dirname "$(get_file_path)"
}

__dotfiles() {
  "$(get_directory_path)/dotfiles-$1"
}

__git() {
  git -C "$(get_directory_path)" "$@"
}

__upgrading() {
  printf "\n\033[1;33m· Upgrading %s\033[0m\n" "$*"
}

# Update dotfiles
if hash git 2> /dev/null; then
  __upgrading dotfiles

  current_revision="$(get_file_revision)"
  __git diff --quiet -- "$(get_file_path)" && __git pull

  # Run the script again if it’s been updated
  if [ "$(get_file_revision)" != "$current_revision" ]; then
    exec "$(get_file_path)"
  fi
fi

# Update Homebrew and installed dependencies
if hash brew 2> /dev/null; then
  __upgrading brew
  brew_cache_path="$(brew --cache)"
  brew update --quiet
  brew upgrade
  brew cleanup --scrub
  rm -rf "$brew_cache_path"
fi

# Link dependencies
__dotfiles init

# Update globally installed Node packages
if hash npm 2> /dev/null; then
  __upgrading npm
  npm --global install npm
  npm --global update
fi

# Update Vim plugins
if hash vim 2> /dev/null; then
  __upgrading vim plugins
  vim -c "PlugUpgrade | PlugUpdate | PlugClean! | quitall"
fi

# Update Fish plugins
if hash fish 2> /dev/null; then
  __upgrading fisher
  fish -c "fisher update"
fi

# Finish with dependency status
__upgrading complete
__dotfiles dependencies
