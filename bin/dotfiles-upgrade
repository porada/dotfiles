#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Update dotfiles
if __is_callable git; then
  __print_heading "Updating dotfiles"

  current_revision="$(__current_file_hash)"

  if __dotfiles_git diff --quiet; then
    __dotfiles_git pull
    __dotfiles_pnpm_install || true
  else
    __print_warning "The repository contains uncommitted changes"
  fi

  if [ "$(__current_file_hash)" != "$current_revision" ]; then
    __print_confirmation "The upgrade script has been updated"
    __dotfiles_exec upgrade
  fi
fi

# Update Homebrew and installed dependencies
if __is_callable brew; then
  __print_heading "Updating Homebrew"

  brew_cache_path="$(brew --cache)"
  brew update --quiet
  brew upgrade || true
  brew cleanup --scrub
  rm -rf "$brew_cache_path"

  # Link installed dependencies
  __dotfiles init --upgrade
fi

# Update globally installed Node packages
if __is_callable npm; then
  __print_heading 'Updating `npm`'

  npm --global --loglevel=error install npm
  npm --global --loglevel=error update
fi

# Update Vim plugins
if __is_callable vim && __is_vim_plug_installed; then
  __print_heading "Updating Vim plugins"

  if vim -c "PlugUpgrade | PlugUpdate | PlugClean! | quitall"; then
    __print_confirmation "Updated"
  else
    __print_error "Update failed"
  fi
fi

# Update Fish plugins
if __is_callable fish && __is_fisher_installed; then
  __print_heading 'Updating `fisher`'

  if ! __fish_eval "fisher update"; then
    __print_error "Update failed"
  fi
fi

# Finish with dependency status
__print_heading "Upgrade complete"
__dotfiles dependencies || true
