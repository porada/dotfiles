#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Update dotfiles
if hash git 2> /dev/null; then
  __print_heading "Updating dotfiles"

  current_revision="$(__current_file_hash)"
  __dotfiles_git diff --quiet -- "$(__current_file_path)" && {
    __dotfiles_git pull
    __dotfiles_pnpm_install
  }

  if [ "$(__current_file_hash)" != "$current_revision" ]; then
    __print_confirmation 'The upgrade script has been updated. Running `dotfiles upgrade` again'
    __dotfiles_exec upgrade
  fi
fi

# Update Homebrew and installed dependencies
if __is_callable brew; then
  __print_heading "Updating Homebrew"

  brew_cache_path="$(brew --cache)"
  brew update --quiet
  brew upgrade || true
  brew cleanup --scrub
  rm -rf "$brew_cache_path"
fi

# Link dependencies
__print_heading 'Running `dotfiles init`'
__print_command "dotfiles init"
__dotfiles init

# Update globally installed Node packages
if __is_callable npm; then
  __print_heading 'Updating `npm`'

  npm --global install npm
  npm --global update
fi

# Update Vim plugins
if __is_callable vim; then
  __print_heading "Updating Vim plugins"
  vim -c "PlugUpgrade | PlugUpdate | PlugClean! | quitall"
  __print_confirmation "Updated"
fi

# Update Fish plugins
if __is_callable fish; then
  __print_heading 'Updating `fisher`'
  fish -c "fisher update"
fi

# Finish with dependency status
__print_heading "Upgrade complete"
__dotfiles dependencies

# Launch updated shell
[ -t 1 ] && exec "$SHELL" -l
