#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

__print_heading "Installing dependencies"
__ brew analytics off

__print_heading_dimmed 'Ensuring `brew` is up to date'

brew_cache_path="$(brew --cache)"
__ brew update --quiet
__ brew upgrade || true
__ brew cleanup --scrub
__ rm -rf "$brew_cache_path"

for formula in fish git node@22 pnpm shellcheck vim; do
  if [ "$formula" = "node@22" ] && __is_brew_installed node; then
    __print_heading 'Replacing `node` with `node@22`'
    __ brew uninstall node || true
  fi

  if ! __is_brew_installed "$formula"; then
    __print_heading "Installing \`$formula\`"
    __ brew install "$formula"
  fi

  __print_heading_dimmed "Linking \`$formula\`"
  __ brew unlink "$formula" || true

  if __is_brew_keg_only "$formula"; then
    __ brew link --overwrite --force "$formula"
  else
    __ brew link --overwrite "$formula"
  fi
done

# Set `fish` as the default shell
fish="$(brew --prefix)/bin/fish"
__is_shell "$fish" && exit 0

# Skip in non-interactive shells or if already registered
if ! __is_tty || grep -qFx -- "$fish" /etc/shells; then
  exit 0
fi

__print_heading 'Setting up `fish` as the default shell'
__ sudo sh -c "echo \"$fish\" >> /etc/shells" || true

if ! __ chsh -s "$fish"; then
  __print_error "Failed to set \`$fish\` as the default shell"
  exit 0
fi
