#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

__print_heading_dimmed "Cleaning up"

# Migrate `extra.fish`
if [ -f "$DOTFILES/extra.fish" ]; then
  mv "$DOTFILES/extra.fish" "$DOTFILES_FISH_DIR/extra.fish"
fi

# Remove `node` in favor of `node@22`
# shellcheck disable=SC2043
for formula in node; do
  if brew list --formula | grep -q "^$formula\$"; then
    brew uninstall $formula
  fi
done

# Clean up legacy launch agents
__find "$DOTFILES/launch-agents" "*.plist" \
  | while IFS= read -r source; do
    agent="$HOME/Library/LaunchAgents/$(basename "$source")"
    legacy_agent="$(__string_replace "engineering.dom" "co.porada.dotfiles" "$agent")"

    if [ "$legacy_agent" != "$agent" ]; then
      legacy_agent_label="$(basename "$legacy_agent" .plist)"

      launchctl bootout "$DOTFILES_LAUNCH_AGENT_DOMAIN" "$legacy_agent_label" 2> /dev/null || true
      launchctl remove "$legacy_agent_label" 2> /dev/null || true

      rm -f "$legacy_agent"
      rm -f "$DOTFILES/launch-agents/$legacy_agent_label.err"
      rm -f "$DOTFILES/launch-agents/$legacy_agent_label.log"
    fi
  done

__print_heading_dimmed 'Ensuring `.ssh` is migrated out of the repository'

SSH_KEY="$HOME/.ssh/id_ed25519"
[ -f "$SSH_KEY" ] || __print_info_and_exit "Nothing to migrate"

if [ -d "$HOME/.ssh" ] && [ ! -L "$HOME/.ssh" ]; then
  __print_confirmation_and_exit "Already migrated"
fi

if [ -d "$DOTFILES/.ssh" ]; then
  [ -L "$HOME/.ssh" ] && rm "$HOME/.ssh"
  mv "$DOTFILES/.ssh" "$HOME/.ssh"
  rm -f "$DOTFILES/.ssh/.keep"
fi

if [ -L "$HOME/.ssh" ] || [ -L "$SSH_KEY" ]; then
  __print_error_and_exit "Migration failed"
fi

__print_confirmation "Migration complete"
__ls "$HOME/.ssh"
