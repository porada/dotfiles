#!/bin/sh

# Enable strict mode
set -eu

DOTFILES="$HOME/.dotfiles"
FISH_CONFIG="$DOTFILES/.config/fish"

# Migrate `extra.fish`
if [ -f "$DOTFILES/extra.fish" ]; then
  mv "$DOTFILES/extra.fish" "$FISH_CONFIG/extra.fish"
fi

# Remove `node` in favor of `node@22`
# (installed through `dotfiles-init-install`)
__error() {
  printf "\n\033[1;31m× %s\033[0m\n" "$*"
  exit 1
}

brew="/opt/homebrew/bin/brew"
[ ! -x "$brew" ] && __error 'Install `brew` first'

for formula in node; do
  if $brew list --formula | grep -q "^$formula\$"; then
    $brew uninstall $formula
  fi
done

# Clean up legacy launch agents
for source in "$DOTFILES"/launch-agents/*.plist; do
  domain="gui/$(id -u)"

  # It’s safe to assume `~/Library/LaunchAgents` always exists
  agent="$HOME/Library/LaunchAgents/$(basename "$source")"
  legacy_agent="$(echo "$agent" | sed 's/engineering\.dom/co.porada.dotfiles/g')"

  if [ "$legacy_agent" != "$agent" ]; then
    legacy_agent_label="$(basename "$legacy_agent" .plist)"

    launchctl bootout "$domain" "$legacy_agent_label" 2> /dev/null || true
    launchctl remove "$legacy_agent_label" 2> /dev/null || true
    rm -f "$legacy_agent"
  fi
done

# Clean up legacy dotfiles
rm -f "$HOME/.lesshst"
rm -f "$HOME/.viminfo"
