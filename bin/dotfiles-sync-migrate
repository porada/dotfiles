#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Migrate `extra.fish`
if [ -f "$DOTFILES/extra.fish" ]; then
  __print_heading_dimmed 'Migrating `extra.fish`'
  __ mv "$DOTFILES/extra.fish" "$DOTFILES_FISH_CONFIG_DIR/extra.fish"
fi

# Remove deprecated `node` versions
for formula in node node@22; do
  if __is_brew_installed "$formula"; then
    __print_heading_dimmed "\`$formula\` will be replaced with \`node@24\`"
    __ brew uninstall "$formula"
  fi
done

# Ensuring `.local` is migrated out of the repository
if [ -d "$DOTFILES/.local" ] && [ -L "$HOME/.local" ]; then
  __print_heading_dimmed "Migrating \`.local\` out of \`$DOTFILES\`"

  __ rm "$HOME/.local"
  __ mv "$DOTFILES/.local" "$HOME/.local"
  __chmod "$HOME/.local"
  __ rm -f "$HOME/.local/.keep"

  if [ -L "$HOME/.local" ]; then
    __print_error_and_exit 'Migration failed'
  else
    __print_confirmation 'Migration complete'
  fi
fi

# Ensuring `.ssh` is migrated out of the repository
if __is_ssh_configured && [ -d "$DOTFILES/.ssh" ] && [ -L "$HOME/.ssh" ]; then
  __print_heading_dimmed "Migrating \`.ssh\` out of \`$DOTFILES\`"

  __ rm "$HOME/.ssh"
  __ mv "$DOTFILES/.ssh" "$HOME/.ssh"
  __ rm -f "$HOME/.ssh/.keep"

  if [ -L "$HOME/.ssh" ] || [ -L "$DOTFILES_SSH_KEY" ]; then
    __print_error_and_exit 'Migration failed'
  else
    __print_confirmation 'Migration complete'
  fi
fi

# Ensuring `.vim` is migrated out of the repository
if [ -d "$DOTFILES/.vim" ] && [ -L "$HOME/.vim" ]; then
  __print_heading_dimmed "Migrating \`.vim\` out of \`$DOTFILES\`"

  __ rm "$HOME/.vim"
  __ mv "$DOTFILES/.vim" "$HOME/.vim"
  __chmod "$HOME/.vim"
  __ rm -f "$HOME/.vim/.keep"

  if [ -L "$HOME/.vim" ]; then
    __print_error_and_exit 'Migration failed'
  else
    __print_confirmation 'Migration complete'
  fi
fi
