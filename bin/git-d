#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Nicer `git diff`
if [ $# -eq 0 ]; then
  excluded_paths="$({
    __git_diff_excluded_files \
      | while IFS= read -r file; do
        if [ -f "$file" ]; then
          git diff-files --quiet "$file" || echo "$file"
        fi
      done
  })"

  if [ -n "$excluded_paths" ]; then
    exclude_params="$({
      printf '%s\n' "$excluded_paths" \
        | while IFS= read -r path; do
          echo ":(exclude)$path"
        done
    })"

    excluded_paths="$({
      __git_diff_excluded_files --related \
        | while IFS= read -r file; do
          if [ -f "$file" ]; then
            git diff-files --quiet "$file" || echo "$file"
          fi
        done
    })"

    # shellcheck disable=SC2086
    if git diff --quiet -- . $exclude_params; then
      git diff -- $excluded_paths
      exit $?
    fi

    # shellcheck disable=SC2086
    {
      echo
      git diff --stat --color=always -- $excluded_paths
      echo
      git diff --patch --color=always -- . $exclude_params
    } | __pager

    exit $?
  fi
fi

git diff "$@"
