#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

# Nicer `git show`
if [ $# -eq 0 ]; then
  set -- HEAD
fi

if [ $# -eq 1 ] && __git_is_commit_reference "$1"; then
  excluded_paths="$({
    __git_diff_excluded_files \
      | while IFS= read -r file; do
        if __git_is_file_in_commit "$1" "$file"; then
          echo "$file"
        fi
      done
  })"

  if [ -n "$excluded_paths" ]; then
    exclude_params="$({
      printf '%s\n' "$excluded_paths" \
        | while IFS= read -r path; do
          echo ":(exclude)$path"
        done
    })"

    # shellcheck disable=SC2086
    {
      git show --stat --color=always "$1" -- $excluded_paths
      git diff-tree --quiet "$1" -- . $exclude_params > /dev/null || echo
      git show --pretty=format: --color=always "$1" -- . $exclude_params
    } | __pager

    exit $?
  fi
fi

git show "$@"
