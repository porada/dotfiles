#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

__print_heading 'Linking dotfiles'

for source in .config/fish .gitconfig .npmrc .vimrc; do
  __symlink "$DOTFILES/$source" "$HOME/$source"
done

if __is_macos && __is_callable pnpm; then
  __symlink "$DOTFILES/.pnpmrc" "$HOME/Library/Preferences/pnpm/rc"
fi

__print_heading_dimmed 'Provisioning extra files'

__touch "$DOTFILES_FISH_DIR/extra.fish"
__touch "$HOME/.hushlogin"
__touch "$HOME/.ssh/.aiexclude"
__mkdir "$HOME/Projects"

__print_heading_dimmed 'Ensuring proper permissions'

__chmod "$DOTFILES"
__chmod "$HOME/.ssh"

__print_heading 'Verifying SSH setup'

if __is_ssh_configured; then
  __print_confirmation "$DOTFILES_SSH_KEY"
else
  __print_error 'No SSH key found'
  exit 0
fi

if __is_macos; then
  __print_heading_dimmed 'Ensuring the SSH key is linked to Apple Keychain'
  __ssh_add --apple-use-keychain "$DOTFILES_SSH_KEY"
fi
