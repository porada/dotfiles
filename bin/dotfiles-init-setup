#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

__print_heading "Linking all dotfiles"

for source in .config/fish .gitconfig .hushlogin .local .npmrc .vim .vimrc; do
  __symlink "$DOTFILES/$source" "$HOME/$source"
done

__print_heading_dimmed "Provisioning extra files"

__touch "$DOTFILES_FISH_DIR/extra.fish"
__touch "$HOME/.local/share/.aiexclude"
__touch "$HOME/.node_history"
__touch "$HOME/.ssh/.aiexclude"
mkdir -p "$HOME/Projects"

__print_heading_dimmed "Ensuring consistent permissions"

__chmod "$DOTFILES"
__chmod "$DOTFILES_FISH_DIR/extra.fish"
__chmod "$HOME/.node_history"
__chmod "$HOME/Projects"

__print_heading "Verifying SSH setup"

SSH_KEY="$HOME/.ssh/id_ed25519"

if [ -f "$SSH_KEY" ]; then
  __print_confirmation "$SSH_KEY"
else
  __print_error_and_exit "No SSH key found at \`$SSH_KEY\`"
fi

if __is_macos; then
  __print_heading_dimmed "Ensuring the SSH key is linked to Apple Keychain"
  __ssh_add --apple-use-keychain "$SSH_KEY"
fi

__print_heading_dimmed 'Ensuring dotfilesâ€™ origin uses SSH'

current="$(command git -C "$DOTFILES" remote get-url origin)"
updated="$(__string_replace 'https://github.com/' 'git@github.com:' "$current")"

if [ "$current" = "$updated" ]; then
  __print_confirmation "$current"
else
  __dotfiles_git remote set-url origin "$updated"
fi
