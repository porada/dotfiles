#!/bin/sh

# shellcheck source=bin/domlib
. "$(dirname "$(realpath "$0")")/domlib"

__print_heading "Installing dependencies"
__is_ci && __ brew --version
__ brew analytics off

__print_heading_dimmed 'Ensuring `brew` is up to date'
__ brew update --quiet

if __is_ci; then
  __ brew --version
else
  __ brew upgrade --overwrite || true
fi

install() {
  if ! __is_brew_installed "$1"; then
    __print_heading "Installing \`$1\`"
    __ brew install --quiet "$1"
  fi

  if [ "$1" = 'pnpm' ] || [ "$1" = 'yarn' ] || __is_brew_keg_only "$1"; then
    __print_heading_dimmed "Ensuring \`$1\` is linked"
    __ brew unlink --quiet "$1" || true
    __ brew link --quiet --overwrite --force "$1"
  fi

  if [ "$1" = 'pnpm' ] && __is_callable pnpm; then
    __mkdir "$DOMFILES_FISH_CONFIG_DIR/completions"
    pnpm completion fish > "$DOMFILES_FISH_CONFIG_DIR/completions/pnpm.fish"
  fi

  if [ "$1" = 'node@24' ] && __is_callable npm; then
    __is_callable corepack && corepack cache clean
    __ npm --global --loglevel=error uninstall corepack
  fi
}

# Install primary dependencies
for formula in fish git node@24 pnpm vim; do
  install "$formula"
done

# Install development dependencies
if ! __is_ci; then
  for formula in fd ripgrep shellcheck yarn; do
    install "$formula"
  done
fi

# Clean up `brew` cache
__ brew cleanup --scrub --quiet
__ rm -rf "$(brew --cache)"

# Install `fisher`
if __is_callable fish && ! __is_fisher_installed; then
  __print_heading 'Installing `fisher`'
  curl \
    --fail \
    --location \
    'https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish' \
    | fish --command 'source /dev/stdin && fisher install jorgebucaran/fisher'
fi

# Install `vim-plug`
if __is_callable vim && ! __is_vim_plug_installed; then
  __print_heading 'Installing `vim-plug`'
  curl \
    --fail \
    --location \
    --output "$DOMFILES_VIM_PLUG" \
    --create-dirs \
    'https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
fi

# Set `fish` as the default shell
fish="$(brew --prefix)/bin/fish"
__is_shell "$fish" && exit 0

# Skip in non-interactive shells
if __is_ci || ! __is_tty; then
  exit 0
fi

if ! grep -qFx -- "$fish" /etc/shells; then
  __print_heading 'Adding `fish` to `/etc/shells`'
  __ sudo sh -c "echo \"$fish\" >> /etc/shells" || true
fi

__print_heading_dimmed 'Setting up `fish` as the default shell'

if __ chsh -s "$fish"; then
  __print_confirmation "$fish"
else
  __print_error "Failed to set \`$fish\` as the default shell"
fi
