#!/bin/sh

# shellcheck source=bin/domlib
. "$(dirname "$(realpath "$0")")/domlib"

if ! __is_brew_installed; then
  __print_error_and_exit '`brew` needs to be installed before running `domfiles sync`'
fi

if __is_callable git; then
  __print_heading 'Syncing domfiles'

  # Ensure the remote uses SSH
  if __is_ssh_configured; then
    current="$(git -C "$DOMFILES" remote get-url origin)"
    updated="$(__string_replace 'https://github.com/' 'git@github.com:' "$current")"
    updated="$(__string_replace 'porada/dotfiles' 'porada/domfiles' "$updated")"

    if [ "$current" = "$updated" ]; then
      __print_confirmation "$current"
    else
      __ git -C "$DOMFILES" remote set-url origin "$updated"
    fi

    if __is_macos; then
      __print_heading_dimmed 'Ensuring the SSH key is linked to Apple Keychain'
      __ssh_add --apple-use-keychain "$DOMFILES_SSH_KEY"
    fi
  fi

  __print_heading_dimmed 'Fetching the latest changes'
  current_revision="$(__domfiles_revision)"

  if ! __ git -C "$DOMFILES" fetch --quiet; then
    __print_error 'Failed to fetch latest changes'
  elif __ git -C "$DOMFILES" merge-base --is-ancestor '@{u}' HEAD; then
    __print_confirmation 'Up to date'
  else
    __print_heading 'Updating the repository'

    if ! __domfiles_is_clean; then
      __print_warning 'The repository contains uncommitted changes'
      __ git -C "$DOMFILES" stash
      stashed_changes=true
    fi

    if ! __ git -C "$DOMFILES" rebase; then
      echo
      __print_error 'Failed to update the repository'
      __ git -C "$DOMFILES" rebase --abort || true
    else
      __is_callable pnpm && __ pnpm --dir "$DOMFILES" --silent install
      __print_confirmation 'Repository updated'
    fi
  fi

  if [ -n "${stashed_changes-}" ]; then
    if __ git -C "$DOMFILES" stash pop --quiet; then
      __print_confirmation 'Changes restored'
    else
      __print_error 'Failed to restore uncommitted changes'

      __print_heading_dimmed 'Restoring the original state'
      __ git -C "$DOMFILES" reset --hard "$current_revision"
      __is_callable pnpm && __ pnpm --dir "$DOMFILES" --silent install

      if __ git -C "$DOMFILES" stash pop --quiet; then
        __print_confirmation 'Original state restored'
      else
        __print_error 'Failed to restore the original state'
      fi
    fi
  fi

  if [ "$(__domfiles_revision)" != "$current_revision" ]; then
    __print_heading_dimmed 'Restarting the sync after the update'
    __domfiles_exec sync --print
  fi
fi

__domfiles sync-migrate
__domfiles sync-setup
__domfiles sync-install
__domfiles sync-macos
__domfiles sync-update
__domfiles sync-clean

# Finish with dependency status
__print_heading 'Sync complete'
__domfiles dependencies || true
__is_fish || echo

# Record the last successful sync
date +%s > "$DOMFILES/.lastsync"
