#!/bin/sh

# shellcheck source=bin/dotlib
. "$(dirname "$(realpath "$0")")/dotlib"

__print_heading "Configuring macOS"

if ! __is_macos; then
  __print_info_and_exit "Skipping configuration. This isn’t macOS"
fi

# Enable full keyboard access for all controls
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# Disable window animations and Get Info animations in Finder
defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
defaults write com.apple.finder DisableAllAnimations -bool true

# Show Library in Finder
chflags nohidden ~/Library

# Disable font smoothing
defaults -currentHost write -g AppleFontSmoothing -int 0

# Disable screenshot thumbnails
defaults write com.apple.screencapture show-thumbnail -bool false

# Disable prompt line marks
defaults write com.apple.Terminal ShowLineMarks -int 0

# Set Dock icons to a specific size and make hidden applications translucent
defaults write com.apple.dock tilesize -int 48
defaults write com.apple.dock showhidden -bool true

# Set the consistent clock style on the login screen
defaults write com.apple.loginwindow ClockFontIdentifier -string "rounded"
defaults write com.apple.loginwindow ClockFontWeight -int 500

# Disable autoplay in the App Store
defaults write com.apple.AppStore AutoPlayVideoSetting -string off
defaults write com.apple.AppStore UserSetAutoPlayVideoSetting -int 1

# Don’t prompt for reviews
defaults write com.apple.AppStore InAppReviewEnabled -bool false

# Quit the printer app when finished
defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

__print_heading_dimmed "Setting up Launch Agents"

for source in "$DOTFILES"/launch-agents/*.plist; do
  domain="gui/$(id -u)"

  agent="$HOME/Library/LaunchAgents/$(basename "$source")"
  agent_label="$(basename "$agent" .plist)"

  __symlink "$source" "$agent"

  launchctl bootout "$domain" "$agent_label" 2> /dev/null || true
  launchctl bootstrap "$domain" "$agent" 2> /dev/null || true
  launchctl kickstart -k "$domain/$agent_label"
done
